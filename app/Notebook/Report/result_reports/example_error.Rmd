---
title: "Example of lower dimension marginal having higher drift than all attributes"
author: "Loong Kuan"
---

```{r setup, message = FALSE, warning=FALSE}
library(foreign)
library(plyr)
source("../../../core/drift_timeline/timeline.R")
source("../../../core/visualisation.R")
source("../../../core/visualise_results/result_table.R")
source("../../../core/visualise_results/heatmaps.R")
source("../../../core/visualise_results/detailed_likelihood.R")
source("../../../core/visualise_results/detailed_posterior.R")
source("../../../core/verification/compare_distributions.R")
source("../../../core/verification/measure_distance.R")
```

```{r electricity, echo = FALSE, message = FALSE, warning = FALSE}
PlotAllWindowSizes("POSTERIOR", 1, "../../../../../data_out/elecNormNew/moving_chunk/", c())
```

```{r}
    data.all <- read.arff("../../../../../datasets/elecNormNew.arff")
    data.before <- data.all[seq(33601, 33936), ]
    data.middle <- data.all[seq(33937, 34272), ]
```

# Single attribute (nswprice)
```{r}
    nswprice.breaks <- EqualFreqBreaks(data.all, 4, 5)
    nswprice.before.hist <- ConstructFrequencyMatrix(data.before, 4, c("DOWN", "UP"), nswprice.breaks)
    print(nswprice.before.hist)
    nswprice.middle.hist <- ConstructFrequencyMatrix(data.middle, 4, c("DOWN", "UP"), nswprice.breaks)
    print(nswprice.middle.hist)
    
    nswprice.before.total.prob <- sapply(seq(1, ncol(nswprice.before.hist)), 
                                         function(x) sum(nswprice.before.hist[,x])/sum(nswprice.before.hist))
    nswprice.middle.total.prob <- sapply(seq(1, ncol(nswprice.middle.hist)), 
                                         function(x) sum(nswprice.middle.hist[,x])/sum(nswprice.middle.hist))
    nswprice.total.prob <- (nswprice.middle.total.prob + nswprice.before.total.prob) / 2
    print(nswprice.total.prob)
    print(sum(nswprice.total.prob))
    
    nswprice.before.prob <- sapply(seq(1, ncol(nswprice.before.hist)), 
                                   function(x) nswprice.before.hist[,x]/sum(nswprice.before.hist[,x]))
    nswprice.middle.prob <- sapply(seq(1, ncol(nswprice.middle.hist)), 
                                   function(x) nswprice.middle.hist[,x]/sum(nswprice.middle.hist[,x]))
    nswprice.before.prob[is.na(nswprice.before.prob)] <- 0
    nswprice.middle.prob[is.na(nswprice.middle.prob)] <- 0
    print(nswprice.before.prob)
    print(nswprice.middle.prob)
    
    nswprice.prob.dist <- abs(nswprice.before.prob - nswprice.middle.prob) / 2
    nswprice.prob.dist <- sapply(seq(1, ncol(nswprice.prob.dist)), 
                                 function(x) nswprice.prob.dist[, x] * nswprice.total.prob[x])
    print(nswprice.prob.dist)
    total.dist <- sum(nswprice.prob.dist)
```

Final Distance:
```{r}
    print(total.dist)
```

# All Attribute
```{r}
    data.all <- data.all[, c(seq(2, 7), ncol(data.all))]
    allAttFreqTable <- function(data.discrete) {
        data.discrete <- data.frame(t(sapply(seq(1,nrow(data.discrete)), function(x) 
            c(paste(data.discrete[x, seq(1,6)], collapse = "_"), data.discrete[x, 7]))))
        data.discrete <- count(data.discrete[, c(1,2)])
    
        data.discrete.down <- data.discrete[data.discrete[, 2] == "DOWN", c(1,3)]
        data.discrete.up <- data.discrete[data.discrete[, 2] == "UP", c(1,3)]
        
        names.all <- unique(c(as.character(data.discrete.down[, 1]), as.character(data.discrete.up[, 1])))
        
        freq.table <- data.frame(sapply(names.all,
                             function(x) c(max(data.discrete.down[data.discrete.down[, 1] == x, 2], 0), 
                                           max(data.discrete.up[data.discrete.up[, 1] == x, 2], 0))))
        names(freq.table) <- names.all
        rownames(freq.table) <- c("DOWN", "UP")
        return(freq.table)
    }

    data.discrete <- sapply(data.all, function(x) if(!is.numeric(x)) x else cut_number(x, 5))
    freq.before <- allAttFreqTable(data.discrete[seq(33601, 33936), ])
    freq.after <- allAttFreqTable(data.discrete[seq(33937, 34272), ])
    
    values.all <- unique(c(names(freq.before), names(freq.after)))
         
    before.total.prob <- c(sapply(seq(1, ncol(freq.before)),
                                         function(x) sum(freq.before[,x])/sum(freq.before)))
    names(before.total.prob) <- names(freq.before)
    after.total.prob <- c(sapply(seq(1, ncol(freq.after)),
                                         function(x) sum(freq.after[,x])/sum(freq.after)))
    names(after.total.prob) <- names(freq.after)
    total.prob <- sapply(values.all, 
                         function(x) (max(before.total.prob[names(before.total.prob) == x], 0) 
                                      + max(after.total.prob[names(after.total.prob) == x], 0)) / 2)
    names(total.prob) <- values.all

    before.prob <- (sapply(seq(1, ncol(freq.before)),
                                   function(x) freq.before[,x]/sum(freq.before[,x])))
    after.prob <- (sapply(seq(1, ncol(freq.after)),
                                   function(x) freq.after[,x]/sum(freq.after[,x])))
    nswprice.before.prob[is.na(nswprice.before.prob)] <- 0
    nswprice.middle.prob[is.na(nswprice.middle.prob)] <- 0
    before.prob <- data.frame(before.prob)
    row.names(before.prob) <- c("DOWN", "UP")
    after.prob <- data.frame(after.prob)
    row.names(after.prob) <- c("DOWN", "UP")

    prob.diff <- data.frame(sapply(values.all, function(x) max(total.prob[names(total.prob) == x], 0) * 
                            abs((if(x %in% names(freq.before)) before.prob[, names(freq.before) == x] 
                                 else c(0,0)) - 
                                    (if(x %in% names(freq.after)) after.prob[, names(freq.after) == x] 
                                     else c(0,0))) / 2))
```

Final Distance:
```{r}
    print(sum(prob.diff))
```

Below are the frequencies for the different attribute value combinations before and after drift respectively:
```{r}
    names(freq.before) <- paste0('x', 1:(ncol(freq.before)))
    print(freq.before)
    print(sum(freq.before))
    print(nrow(data.before))
    names(freq.after) <- paste0('x', 1:(ncol(freq.after)))
    print(freq.after)
    print(sum(freq.after))
    print(nrow(data.middle))
```

The probability of each of the possible values bothe before and after the drift
```{r}
    names(total.prob) <- paste0('x', 1:(length(total.prob)))
    print(total.prob)
```

Below are the joint probabilities for the different attribute value combinations before and after drift respectively:
```{r}
    print(before.prob)
    print(after.prob)
    names(prob.diff) <- paste0('x', 1:(ncol(prob.diff)))
    print(prob.diff)
```

